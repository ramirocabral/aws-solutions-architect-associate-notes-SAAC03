![[Pasted image 20221101113016.png]]
# Amazon S3

- Object based storage.
- Infinetly scalable.
- Read after write consistency.

## Buckets

- Name must have a globally unique name (across all regions, all accounts).
- Defined at the region level.
- Stores objects.

## Objects

- Key : Full PATH. Composed of prefix + object name.
- Object values are the content of the body.
- Max Size: 5 TB.
- If uploading more than 5GB, must be "multi-part upload".
- If versioning enabled, objects have a version ID.

## Security

- **User-Based**:
  - **[[IAM]] policies**: wich API calls should be allowd for a user.
- **Resource-Based**:
  - **Bucket policies**: bucket-wide rules. Allow cross-account access.
  - ACL. Can be disabled.
  - Bucket ACL. Can be desabled. Less common.

## Versioning

- Enabled at the bucket level.
- Same key overwrite will change the version: 1, 2,3...
- Easy roll back, useful in case of accidental deletion.

## Replication

- **Must have versioning enabled** in source and destination.
- **Cross-Region Replication (CRR)**. Compliance, lower latency, replication across accounts.
- **Same-Region Replication (SRR)**. Log aggregation, replicate prod and test accounts.
- Buckets can be in different accounts.
- Asynchronous replication.
- After enabling replication, only new objects will be replicated.
- Can replicate existing objects using **Batch Replication**.
- For DELETE operations:
  - Can replicate delete markers from source to target (optional).
  - Deletions with version ID are not replicated.

## Storage Classes

Every class has 99.99999999999%, (11 9's) durability across multiple AZs.

- **Standard**: General purpose, frequently accessed. 99.99% availability.
- **Standard Infrequent Access**: Infrequently accessed, but rapid access when needed. Lower storage cost. 99.9% availability.
- **One-Zone Infrequent Access**: Same as Standard-IA, but stored in a single AZ. 99.5% availability.
- **Glacier Instant Retrieval**: Minimum storage duration 90 days. Retrieval in milliseconds.
- **Glacier Flexible Retrieval**: Minimum storage duration 90 days.
  - Expedited retrieval: 1-5 minutes.
  - Standard retrieval: 3-5 hours.
  - Bulk retrieval: 5-12 hours.
- **Glacier Deep Archive**: Minimum storage duration 180 days.
  - Standard retrieval: 12 hours.
  - Bulk retrieval: 48 hours.

### Intelligent-Tiering

- Small monthly monitoring and auto tiering fee.
- Move objects between tiers based on access patterns.
- No retrieval fees.

## Lifecycle Rules

<img src="attachments/s3_storage_classes.png" width="600"/>

- **Transaction Actions**: configure objects to transition to another class
  - e.g move objects to Standar IA after 60 days.
- **Expiration Actions**: configure objects to expire (delete) after some time.
  - Can be used to delete old versions of files (if versioning enabled), or incomplete multi-part uploads.

Rules can be created for a certain prefix or certain tags.

**Storage Class Analysis** -> Helps to decide when to transition objects (only for Standard and Standard-IA). Reported updated daily.


## Requester Pays

- Requester pays the cost of the request and the data download.
- Useful to share large data sets with other accounts.
- Requester must be authenticated in AWS.

## S3 Event Notifications

- Trigger an action (Lambda, SNS, SQS) on API request to the bucket.
- Can also use Event Bridge for more targets and filters.
- Can create as many events as desired.
- We need to add permissions on the desired service to allow S3 to interact with it. (Resource Policies)

## Baseline Performance

- S3 automatically scales to high request rates, latency 100-200 ms.
- Your app can handle up to 3500 PUT/COPY/POST/DELETE or 5500 GET/HEAD request per second per prefix in a bucket.
- No limits to number of prefixes in a bucket.

### Optimizing Performance

- **Multi-Part upload**:
  - recommended for files > 100MB. Must use for files > 5GB.
  - Can help parallelize uploads.
- **Transfer Acceleration**:
  - Uses Edge locations to speed up uploads.
  - Compatible with multi-part upload.
- **Byte-Range Fetches**:
  - Parallelize GETs by requesting specific byte ranges.
  - Speed up downloads.
  - Retrieve only partial data.

## S3 Batch Operations

- Perform bulk operations on existing objecs with a single request:
  - Modify metadata.
  - Copy objects between buckets.
  - Encryp un-encrypted objects.
  - Invoke Lambda function on objects.
- Batch Operations manages retries, progress, completion notifications, reports, etc.
- Can use S3 Inventory to get object list and user Athena to query and filter objects.

## S3 Storage Lens

- Understand, analyze, and optimize storage across an entire AWS Organization.
- Default dashboard or create custom dashboards.
- Can export metrics daily to a bucket.

### Default Dashboard

- Multi-Region and Multi-Account data.
- Can't be deleted, can be disabled.

### Metrics

- **Summary Metrics**: General insights about storage. StorageBytes, ObjectCount, etc.
- **Cost-Optimization Metrics**: Insights to manage and optimize costs.
- **Data-Protection Metrics**: Inights to help protect data.
- **Access-Management Metrics**: Provide insights for Object Ownership.
- **Event Metrics**: Insights for S3 Event Notifications.
- **Performance Metrics**: Insights for S3 Transfer Acceleration.
- **Activity Metrics**: Insights about how the storage is requested.
- **Detailed Status Code Metrics**: Insights HTTP status codes.

### Free vs Paid Metrics

- Free metrics:
  - Data available for 14 days.
  - Around 28 usage metrics.
- Advanced metrics and recommendations:
  - Advanced Metrics.
  - CloudWatch Publishing.
  - Prefix Aggregation.
  - Data available for 15 months.

## Encryption

### Server-Side Encryption (SSE)

**You can use Bucket Policies to enforce encryption.**

#### SSE-S3

- S3 managed keys. Default encryption.
- AES-256.
- Must set header `x-amz-server-side-encryption` to `AES256`.
- Enabled by default for new buckets and objects.

#### SSE-KMS

- Encryption using keys handled and managed by KMS
- KMS advantages: user control + audit key usage with CloudTrail.
- Must set header `x-amz-server-side-encryption` to `aws:kms`.
- You may be impacted by KMS limits.
- You can experience throttling if you exceed KMS limits.

#### SSE-C

- Keys fully managed by the customer outside of AWS.
- S3 does NOT store the enctyption key provided.
- HTTPS **MUST** be used.
- Encryption key must provided in HTTP headers, for every request made.

### Client-Side Encryption

- Use client libraries such as S3 Client-Side Encryption Library.
- Clients must encrypt data themselves before uploading to S3 and when retrieving from S3.
- Customer fully manages the keys and endcryption cycle.

### Encryption in Transit (SSL/TLS)

S3 exposes two endpoints:

- HTTP endpoint.
- HTTPS endpoint.

To enforce encryption in transit, you can force it using a Bucket Policy.

## CORS

- If a client makes a Cross-Origin request on our bucket, we need to enable the correct CORS headers.
- Can use specific origin or * for all origins.

## MFA Delete

- Force users to generate a code on a device before doing important operations on S3.
- Versioning must be enabled.
- Only the Root Account can enable/disable MFA Delete.

Required to:

- Permanently delete an object version.
- Suspend versioning on a bucket.

Not required to:

- Enable versioning.
- List deleted versions.

## Access Logs

- Logs ANY request made to S3 into another bucket.
- Target logging bucket must be in the same region.
- NEVER set your logging bucket to be the monitored bucket. (loop)

## Pre-Signed Urls
- Users given a pre-signed URL inherit permissions of the user that generated it for GET/PUT.
- URL expiration:
  - S3 Console: 1 min up to 12 hours.
  - AWS CLI: default 3600 secs, max 168 hours.

## Glacier Vault Lock

- Adopt a WORM (Write Once Read Many) model.
- Create a Vault Lock Policy.
- Lock the policy for future edits. (can no longer be changed)

## S3 Object Lock

- Versioning must be enabled.
- Block an object version deletion for a specified amount of time.
- **Retention mode**:
  - **Compliance**: Objects verions can't be changed by ANY user, not even the root user.
  - **Governance**: most users can't alter the lock settings, but some users can.
- **Retention period**: protect the object for a fixed amount of time, can be extended.
- **Legal hold**: protect the object indefinetly, independent from retention period / retention mode. Can be freely placed and removed using an IAM permission.

## S3 Access Points

- Create unique access points for different applications. Each with his DNS name.
- Attach policies to each access point.
- Scale access to buckets.
- **VPC Origin**: Define the access point to be accessible only from within a VPC. Must create a VPC Endpoint. It must have access to the buket and the Access Point.

### Object Lambda

- Use Lambdas to change the object before it is retrieved by a caller application.
- Only one bucket is needed, on top of which we create S3 Access Point and S3 Object Lambda Access Point.

<img src="attachments/s3_object_lambdas.png" width="500"/>

