![[Pasted image 20221101114927.png]]
# Elastic Load Balancer

## TLDR

AWS managed load balancers. Is used to spread and control traffic to a vertically scaled infrastructre.

## Features

- Server which forwands traffic to other services (e.g. [[EC2]]).
- Spreads load.
- Expose single DNS access.
- Seamlessly handle failures.
- Health checks.
- Provides HTTPS to instances (SSL termination).
- Enforce stickyness with cookies.
- High availabliy AZs.
- Separate public traffic from private traffic.
- Can be setup as internal or external.

## Compatible services
- [[EC2]]
- [[EC2]] [[ASG]]
- [[ECS]]
- [[ACM]]
- [[CloudWatch]]
- [[Route53]]
- [[WAF]]
- [[GlobalAccelerator]]

## Health checks

- Are done on a Port and a Route (e.g /health).
- If the health check fails (not 200 OK), the instance is marked as unhealthy.
- Target group level.

## Classic Load Balancer

- HTTP, HTTPS (layer 7), TCP (Layer 4), SSL.
- **Deprecated**.(won't appear in the exam).

## Application Load Balancer

- HTTP, HTTPS, WebSockets (layer 7).
- Load balancing HTTP apps across machines (**target groups**).
- Load balancing to multiple apps in one machine (e.g containers).
- Port mapping -> redirect to a dynamic port on ECS.
- Fixed hostname (XXX.region.elb.amazonaws.com).
- App servers dont see the clients ip directly, the IP is inserted in the header (X-Forwarded-For). Also, we get (X-Forwarded-Proto, X-Forwarded-Port).
- Cannot attach Elastic IP.
- **Cross AZ load balancing** enabled by default.

### Target groups

- [[EC2]] Instances. (can be managed by [[ASG]]).
- [[ECS]] Tasks.
- [[Lambda]] functions.
- Private IPs.

Can route to multiple target groups.

### Routing
- Based on path.
- Based on hostname in URL.
- Based on query.

## Network Load Balancer

- TCP, TLS, UDP (Layer 4)
- High performance, less latency.
- One static IP per AZ.
- Supports Elastic IP.
- Health checks with TCP, HTTP or HTTPS.
- Cross AZ load balancing is DISABLED by default.

### Target Groups

- [[EC2]] Instances.
- Private IP Adresses.
- Application Load Balancer ([[ELB]]).

## Gateway Load Balancers

- IP Protocol (Layer 3).
- Deploy scale and manage a fleet of 3rd party network virtual appliances.
- Examples, Firewals, Instrusion Detection, Deep Packet Inspection, payload manipulations
- GENEVE Protocol on port 6081.

### Functions

- **Transparent Network Gateway**: single entry/exit for all trafic.
- **Load Balancer**: distributes traffic to virtual appliances (that check the packages etc etc).

### Target Groups

- [[EC2]] Instances.
- Private IPs.

## Sticky Sessions (Session Affinity)

- The same client is always routed to the same target behind the LB.
- Available on CLB, ALB and NLB (not GLB).
- Controlled via cookies.
- Might bring imbalance.

### Cookie Types

#### Application-based cookies

- **Custom cookie**: 
  - Generated by the target, can include custom attributes.
  - Cookie name is set in the target group.
  - Don't use AWSALB, AWSALBAPP or AWSALBTG, they are reserved for use by ELB.
- **Application cookie**:
  - Generated by the ELB.
  - Cookie name is **AWSALBAPP**.

*Took me quite a while to understand this, the app creates the custom cookie, and the ELB creates ANOTHER COOKIE called AWSALBAPP which is used to track the session. So, the app controls the session*.

#### Duration-based Cookies

- Generated by the LB.
- Cookie name is **AWSALB** for ALB, **AWSELB** for CLB.

## Cross-AZ Load Balancing

- Distributes traffic evenly across all instances in all AZs.
- If not enabled the traffic is distributed evenly across the AZ of the LB.
- For ALB, enabled by default. No additional cost.
- For NLB and GLB, disabled by default. Additional cost for inter-AZ traffic.
- For CLB, disabled by default. No additional cost for inter-AZ traffic.

## SSL/ TLS

- ELB uses x.509 cert.
- Certs can be managed by AWS Certificate Manager ([[ACM]]).
- Can use your own certs.
- Required for HTTPS listener.
- Can add multiple to support multiple domains.
- Can modify security policies to support older versions of SSL.

### SNI (Server Name Indication)

[Useful video](https://www.youtube.com/watch?v=manTiXESYG0)
- Load multiple certs on on server to serve multiple https website on one server.
- Extension to TLS.
- Clients can use this to specify the hostname they reach.
- Client indicates hostname of the target server in inital TLS handshake.
- Only for ALB or NLB or [[Cloudfront]].

## Connection Draining(CLB) / Deregistration Delay(ALB, NLB)

- Time to complete in flight request when the instance is deregistered or terminated.
- Between 1 to 3600 seconds, default is 300.
- Low value if requests are short.

----

**This won't appear on the exam**, I just found it interesting.

## Unhealthy state actions

You can specify a minimum count or a percentage of healthy targets.

Then, you can configure healthy thresholds for the following actions:

- **DNS failover**: If the number of healthy targets is below the threshold, the IP address of the load balancer node for the zone as unhealthy in the DNS. (Route 53 can check the health and failover to another ELB or another resource).

- **Routing failover**: The load balancer routes traffic to all targets available, including unhealthy targets.
